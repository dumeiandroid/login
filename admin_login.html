<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Login</title>
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #0a0a14;
      --panel: #10101e;
      --border: #1e1e3a;
      --accent: #e94560;
      --accent2: #0f3460;
      --text: #c9d1d9;
      --muted: #555577;
      --mono: 'Share Tech Mono', monospace;
      --sans: 'Rajdhani', sans-serif;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--sans);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      position: relative;
    }

    /* Grid background */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image:
        linear-gradient(rgba(233,69,96,0.04) 1px, transparent 1px),
        linear-gradient(90deg, rgba(233,69,96,0.04) 1px, transparent 1px);
      background-size: 40px 40px;
      pointer-events: none;
    }

    /* Glow blob */
    body::after {
      content: '';
      position: fixed;
      width: 600px;
      height: 600px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(233,69,96,0.08) 0%, transparent 70%);
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      pointer-events: none;
      animation: pulse 4s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
      50% { transform: translate(-50%, -50%) scale(1.1); opacity: 0.6; }
    }

    .panel {
      position: relative;
      z-index: 10;
      width: 100%;
      max-width: 420px;
      padding: 20px;
      animation: slideIn 0.5s cubic-bezier(0.16, 1, 0.3, 1) both;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(30px) scale(0.97); }
      to   { opacity: 1; transform: translateY(0) scale(1); }
    }

    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 40px 36px;
      position: relative;
      box-shadow: 0 0 40px rgba(0,0,0,0.6), 0 0 80px rgba(233,69,96,0.05);
    }

    /* Top accent line */
    .card::before {
      content: '';
      position: absolute;
      top: 0; left: 20px; right: 20px;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--accent), transparent);
      border-radius: 2px;
    }

    .logo-area {
      text-align: center;
      margin-bottom: 32px;
    }

    .logo-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 52px;
      height: 52px;
      border: 1.5px solid var(--accent);
      border-radius: 10px;
      margin-bottom: 14px;
      position: relative;
      animation: iconGlow 3s ease-in-out infinite;
    }

    @keyframes iconGlow {
      0%, 100% { box-shadow: 0 0 10px rgba(233,69,96,0.3); }
      50% { box-shadow: 0 0 25px rgba(233,69,96,0.6); }
    }

    .logo-icon svg {
      width: 24px;
      height: 24px;
      fill: var(--accent);
    }

    h1 {
      font-family: var(--sans);
      font-size: 22px;
      font-weight: 700;
      letter-spacing: 3px;
      text-transform: uppercase;
      color: #fff;
    }

    .subtitle {
      font-family: var(--mono);
      font-size: 11px;
      color: var(--muted);
      letter-spacing: 2px;
      margin-top: 4px;
    }

    /* Destination bar */
    .dest-bar {
      background: rgba(233,69,96,0.06);
      border: 1px solid rgba(233,69,96,0.2);
      border-radius: 6px;
      padding: 8px 14px;
      font-family: var(--mono);
      font-size: 11px;
      color: var(--accent);
      margin-bottom: 28px;
      display: flex;
      align-items: center;
      gap: 8px;
      min-height: 36px;
      word-break: break-all;
    }

    .dest-bar .label {
      color: var(--muted);
      white-space: nowrap;
      flex-shrink: 0;
    }

    .dest-bar .value {
      color: #fff;
      opacity: 0.8;
    }

    /* Form */
    .field {
      margin-bottom: 18px;
    }

    label {
      display: block;
      font-family: var(--mono);
      font-size: 11px;
      color: var(--muted);
      letter-spacing: 1.5px;
      text-transform: uppercase;
      margin-bottom: 7px;
    }

    input[type="text"],
    input[type="password"] {
      width: 100%;
      background: #0d0d1a;
      border: 1px solid var(--border);
      border-radius: 7px;
      padding: 11px 14px;
      color: #fff;
      font-family: var(--mono);
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(233,69,96,0.1);
    }

    /* Role selector */
    .role-selector {
      display: flex;
      gap: 10px;
      margin-bottom: 24px;
    }

    .role-btn {
      flex: 1;
      padding: 9px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--muted);
      border-radius: 7px;
      font-family: var(--mono);
      font-size: 12px;
      letter-spacing: 1px;
      cursor: pointer;
      transition: all 0.2s;
      text-transform: uppercase;
    }

    .role-btn.active {
      border-color: var(--accent);
      background: rgba(233,69,96,0.12);
      color: var(--accent);
    }

    /* Secret key toggle */
    .secret-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 18px;
      cursor: pointer;
      user-select: none;
    }

    .secret-toggle input[type="checkbox"] {
      accent-color: var(--accent);
      width: 14px;
      height: 14px;
    }

    .secret-toggle span {
      font-family: var(--mono);
      font-size: 11px;
      color: var(--muted);
      letter-spacing: 1px;
    }

    /* Submit */
    .btn-login {
      width: 100%;
      padding: 13px;
      background: var(--accent);
      border: none;
      border-radius: 7px;
      color: #fff;
      font-family: var(--sans);
      font-size: 16px;
      font-weight: 700;
      letter-spacing: 2px;
      text-transform: uppercase;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
      margin-top: 4px;
    }

    .btn-login::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, transparent 60%);
      pointer-events: none;
    }

    .btn-login:hover:not(:disabled) {
      background: #ff2d4e;
      box-shadow: 0 0 24px rgba(233,69,96,0.5);
      transform: translateY(-1px);
    }

    .btn-login:active {
      transform: translateY(0);
    }

    .btn-login:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Alert */
    .alert {
      display: none;
      padding: 10px 14px;
      border-radius: 6px;
      font-family: var(--mono);
      font-size: 12px;
      margin-top: 14px;
      letter-spacing: 0.5px;
    }

    .alert.error {
      background: rgba(233,69,96,0.1);
      border: 1px solid rgba(233,69,96,0.3);
      color: #ff6b81;
      display: block;
    }

    .alert.success {
      background: rgba(0,200,100,0.08);
      border: 1px solid rgba(0,200,100,0.25);
      color: #4caf88;
      display: block;
    }

    /* Popup overlay */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
    }

    .popup {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 32px 28px;
      width: 340px;
      box-shadow: 0 0 60px rgba(0,0,0,0.8);
      animation: slideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) both;
    }

    .popup h2 {
      font-family: var(--sans);
      font-weight: 700;
      font-size: 16px;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: #fff;
      margin-bottom: 8px;
    }

    .popup p {
      font-family: var(--mono);
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 18px;
      line-height: 1.6;
    }

    .popup input {
      width: 100%;
      background: #0d0d1a;
      border: 1px solid var(--border);
      border-radius: 7px;
      padding: 10px 12px;
      color: #fff;
      font-family: var(--mono);
      font-size: 13px;
      outline: none;
      margin-bottom: 14px;
      transition: border-color 0.2s;
    }

    .popup input:focus {
      border-color: var(--accent);
    }

    .popup .hint {
      font-family: var(--mono);
      font-size: 10px;
      color: var(--muted);
      margin-top: -10px;
      margin-bottom: 14px;
    }

    .popup-btn {
      width: 100%;
      padding: 11px;
      background: var(--accent);
      border: none;
      border-radius: 7px;
      color: #fff;
      font-family: var(--sans);
      font-weight: 700;
      font-size: 14px;
      letter-spacing: 1.5px;
      text-transform: uppercase;
      cursor: pointer;
      transition: all 0.2s;
    }

    .popup-btn:hover {
      background: #ff2d4e;
    }

    .popup-err {
      color: #ff6b81;
      font-family: var(--mono);
      font-size: 11px;
      margin-top: 10px;
      display: none;
    }

    /* Spinner */
    .spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
      vertical-align: middle;
      margin-right: 6px;
    }

    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>

<!-- Popup: masukkan tujuan jika tidak ada ?p= -->
<div class="overlay" id="overlay" style="display:none">
  <div class="popup">
    <h2>Tujuan Halaman</h2>
    <p>Tidak ada tujuan yang ditentukan.<br>Masukkan domain tujuan setelah login:</p>
    <input type="text" id="popupDest" placeholder="contoh: lidan.co.id atau app.lidan.co.id" />
    <div class="hint">Tanpa https://</div>
    <div class="popup-err" id="popupErr">Domain tidak valid.</div>
    <button class="popup-btn" onclick="submitPopup()">Lanjutkan</button>
  </div>
</div>

<!-- Login Panel -->
<div class="panel">
  <div class="card">
    <div class="logo-area">
      <div class="logo-icon">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 4l5 2.18V11c0 3.5-2.33 6.79-5 7.93C9.33 17.79 7 14.5 7 11V7.18L12 5z"/>
        </svg>
      </div>
      <h1>Admin Login</h1>
      <div class="subtitle">SECURE ACCESS PORTAL</div>
    </div>

    <!-- Destination bar -->
    <div class="dest-bar">
      <span class="label">▶ DEST:</span>
      <span class="value" id="destDisplay">—</span>
    </div>

    <!-- Role -->
    <div style="margin-bottom:18px">
      <label>Role</label>
      <div class="role-selector">
        <button class="role-btn active" id="roleAdmin" onclick="setRole('admin')">Admin</button>
        <button class="role-btn" id="roleUser" onclick="setRole('user')">User</button>
      </div>
    </div>

    <!-- Fields -->
    <div class="field">
      <label>Username</label>
      <input type="text" id="username" placeholder="masukkan username" autocomplete="username" />
    </div>
    <div class="field">
      <label>Password</label>
      <input type="password" id="password" placeholder="masukkan password" autocomplete="current-password"
             onkeydown="if(event.key==='Enter') doLogin()" />
    </div>

    <!-- Secret key toggle -->
    <label class="secret-toggle">
      <input type="checkbox" id="useSecret" />
      <span>Gunakan Secret Key (untuk localhost / domain tidak terdaftar)</span>
    </label>

    <button class="btn-login" id="btnLogin" onclick="doLogin()">Masuk</button>

    <div class="alert" id="alertMsg"></div>
  </div>
</div>

<script>
  const API = 'https://lidan-co-id.pages.dev/api/contacts_filter_dinamis7';
  const SESSION_KEY = 'admin_auth_session';
  const SESSION_HOURS = 8;
  const SECRET = 'admin';
  const VERSION = '3.0.0';
  console.log('%c[admin_login.html] v' + VERSION, 'color:#e94560;font-weight:bold;font-size:13px');

  let currentRole = 'admin';
  let destP = '';

  // ─── URL Helpers ───────────────────────────────────────────────
  function pToUrl(p) {
    const path = p.replace(/\|/g, '.').replace(/~/g, '/');
    const host = path.split('/')[0];
    const isLocal = /^localhost(:\d+)?$/.test(host)
                 || /^127\./.test(host)
                 || /^192\.168\./.test(host)
                 || /^10\./.test(host);
    return (isLocal ? 'http://' : 'https://') + path;
  }

  function updateDestDisplay(p) {
    document.getElementById('destDisplay').textContent = p ? pToUrl(p) : '—';
  }

  // ─── Popup: input tujuan manual ────────────────────────────────
  function submitPopup() {
    const val = document.getElementById('popupDest').value.trim();
    const errEl = document.getElementById('popupErr');
    errEl.style.display = 'none';

    if (!val || val.length < 3) {
      errEl.style.display = 'block';
      errEl.textContent = 'Domain tidak boleh kosong.';
      return;
    }

    // Hapus protokol jika user iseng ketik https://
    const clean = val.replace(/^https?:\/\//, '').replace(/\/$/, '');
    // Konversi . → | dan / → ~
    destP = clean.replace(/\./g, '|').replace(/\//g, '~');
    updateDestDisplay(destP);

    const url = new URL(window.location.href);
    url.searchParams.set('p', destP);
    window.history.replaceState({}, '', url.toString());

    document.getElementById('overlay').style.display = 'none';
  }

  document.addEventListener('keydown', (e) => {
    const overlay = document.getElementById('overlay');
    if (overlay.style.display !== 'none' && e.key === 'Enter') submitPopup();
  });

  // ─── Init ──────────────────────────────────────────────────────
  function init() {
    const params = new URLSearchParams(window.location.search);
    destP = params.get('p') || '';

    if (!destP) {
      document.getElementById('overlay').style.display = 'flex';
    } else {
      updateDestDisplay(destP);
    }
  }

  // ─── Role ──────────────────────────────────────────────────────
  function setRole(role) {
    currentRole = role;
    document.getElementById('roleAdmin').classList.toggle('active', role === 'admin');
    document.getElementById('roleUser').classList.toggle('active', role === 'user');
  }

  // ─── UI Helpers ────────────────────────────────────────────────
  function showAlert(msg, type) {
    const el = document.getElementById('alertMsg');
    el.className = 'alert ' + type;
    el.textContent = msg;
  }

  function hideAlert() {
    const el = document.getElementById('alertMsg');
    el.className = 'alert';
    el.textContent = '';
  }

  function setLoading(loading) {
    const btn = document.getElementById('btnLogin');
    if (loading) {
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span>MEMPROSES...';
    } else {
      btn.disabled = false;
      btn.innerHTML = 'Masuk';
    }
  }

  // ─── Encode session ke base64 unicode-safe ─────────────────────
  function encodeSession(session) {
    try {
      // Simpan hanya field penting — hindari token terlalu panjang
      const slim = {
        username: session.username,
        role: session.role,
        expiry: session.expiry,
      };
      const jsonStr = JSON.stringify(slim);
      return btoa(unescape(encodeURIComponent(jsonStr)));
    } catch (e) {
      console.error('[login] Gagal encode session:', e);
      return null;
    }
  }

  // ─── Login ─────────────────────────────────────────────────────
  async function doLogin() {
    hideAlert();
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;
    const useSecret = document.getElementById('useSecret').checked;

    if (!username || !password) {
      showAlert('Username dan password tidak boleh kosong.', 'error');
      return;
    }

    if (!destP) {
      showAlert('Tentukan tujuan halaman terlebih dahulu.', 'error');
      document.getElementById('overlay').style.display = 'flex';
      return;
    }

    setLoading(true);

    try {
      const headers = {
        'Content-Type': 'application/json',
        'X-Role': currentRole,
      };

      // Pakai secret key untuk localhost atau jika dicentang manual
      const hostname = window.location.hostname;
      const isLocal = hostname === 'localhost' || hostname === '127.0.0.1'
                   || hostname.startsWith('192.168.') || hostname.startsWith('10.');
      if (useSecret || isLocal) {
        headers['X-Custom-Auth'] = SECRET;
      }

      const res = await fetch(API + '?action=login', {
        method: 'POST',
        headers,
        // TIDAK pakai credentials:include agar tidak trigger CORS preflight masalah
        body: JSON.stringify({ username, password }),
      });

      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        showAlert(err.message || 'Server error: ' + res.status, 'error');
        return;
      }

      const data = await res.json();

      if (data.success) {
        // Buat session — simpan hanya data minimal agar token tidak terlalu panjang
        const session = {
          username,
          role: currentRole,
          expiry: Date.now() + SESSION_HOURS * 60 * 60 * 1000,
        };

        const token = encodeSession(session);
        if (!token) {
          showAlert('Gagal membuat token session.', 'error');
          return;
        }

        showAlert('✓ Login berhasil! Mengalihkan...', 'success');

        // Redirect ke halaman tujuan dengan token di hash
        const targetUrl = pToUrl(destP) + '#auth=' + encodeURIComponent(token);
        console.log('[login] Redirect ke:', targetUrl);

        setTimeout(() => {
          window.location.href = targetUrl;
        }, 700);

      } else {
        showAlert(data.message || 'Username atau password salah.', 'error');
      }

    } catch (err) {
      console.error('[login] Fetch error:', err);
      showAlert('Gagal terhubung ke server. Periksa koneksi internet.', 'error');
    } finally {
      setLoading(false);
    }
  }

  init();
</script>
</body>
</html>